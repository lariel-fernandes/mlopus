<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlopus.mlflow.api.base &mdash; MLOpus 0.3.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/autodoc_pydantic.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/my_theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx_paramlinks.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            MLOpus
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst/mlflow/index.html">MLflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst/artschema/index.html">Artifact Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst/kedro/index.html">Kedro Extensions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../rst/lineage.html">Lineage</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">MLOpus</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mlopus.mlflow.api.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mlopus.mlflow.api.base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Mapping</span>

<span class="kn">from</span> <span class="nn">mlopus.utils</span> <span class="kn">import</span> <span class="n">pydantic</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">mongo</span><span class="p">,</span> <span class="n">string_utils</span><span class="p">,</span> <span class="n">iter_utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">contract</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">schema</span><span class="p">,</span> <span class="n">decorators</span><span class="p">,</span> <span class="n">serde</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">transfer</span>
<span class="kn">from</span> <span class="nn">.exp</span> <span class="kn">import</span> <span class="n">ExpApi</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">ModelApi</span>
<span class="kn">from</span> <span class="nn">.mv</span> <span class="kn">import</span> <span class="n">ModelVersionApi</span>
<span class="kn">from</span> <span class="nn">.run</span> <span class="kn">import</span> <span class="n">RunApi</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>  <span class="c1"># Any type</span>

<span class="c1"># Entity types</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Experiment</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Run</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Model</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">ModelVersion</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">BaseEntity</span><span class="p">)</span>

<span class="c1"># Identifier types</span>
<span class="n">ExpIdentifier</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">ExpIdentifier</span> <span class="o">|</span> <span class="n">ExpApi</span>
<span class="n">RunIdentifier</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">RunIdentifier</span> <span class="o">|</span> <span class="n">RunApi</span>
<span class="n">ModelIdentifier</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">ModelIdentifier</span> <span class="o">|</span> <span class="n">ModelApi</span>
<span class="n">ModelVersionIdentifier</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">ModelVersionIdentifier</span> <span class="o">|</span> <span class="n">ModelVersionApi</span>


<div class="viewcode-block" id="BaseMlflowApi"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi">[docs]</a><span class="k">class</span> <span class="nc">BaseMlflowApi</span><span class="p">(</span><span class="n">contract</span><span class="o">.</span><span class="n">MlflowApiContract</span><span class="p">,</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for API clients that use &quot;MLflow-like&quot; backends for experiment tracking and model registry.</span>

<span class="sd">    Important:</span>
<span class="sd">        Implementations of this interface are meant to be thread-safe and independent of env vars/globals,</span>
<span class="sd">        so multiple API instances can coexist in the same program if necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Root path for cached artifacts and metadata. &quot;</span>
            <span class="s2">&quot;If not specified, then a default is determined by the respective API plugin.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">offline_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If True, block all operations that attempt communication &quot;</span>
            <span class="s2">&quot;with the MLflow server or artifacts repositories &quot;</span>
            <span class="s2">&quot;(i.e.: work with local cache only).&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">temp_artifacts_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Path for temporary artifacts that are stored by artifact dumpers before being published and preserved &quot;</span>
            <span class="s2">&quot;after a publish error (e.g.: an upload interruption). Defaults to a path inside the local cache.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">cache_local_artifacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Use local cache even if the run artifacts repository is in the local file system. &quot;</span>
            <span class="s2">&quot;May be used for testing cache without connecting to a remote MLflow server.&quot;</span>
            <span class="s2">&quot;Not recommended in production because of unecessary duplicated disk usage. &quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">always_pull_artifacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;When accessing a cached artifact file or dir, re-sync it with the remote artifacts repository, even &quot;</span>
            <span class="s2">&quot;on a cache hit. Prevents accessing stale data if the remote artifact has been changed in the meantime. &quot;</span>
            <span class="s2">&quot;The default data transfer utility (based on rclone) is pretty efficient for syncing directories, but &quot;</span>
            <span class="s2">&quot;enabling this option may still add some overhead of calculating checksums if they contain many files.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">file_transfer</span><span class="p">:</span> <span class="n">transfer</span><span class="o">.</span><span class="n">FileTransfer</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">transfer</span><span class="o">.</span><span class="n">FileTransfer</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Utility for uploading/downloading artifact files or dirs. Also used for listing files. Based on &quot;</span>
            <span class="s2">&quot;RClone by default. Users may replace this with a different implementation when subclassing the API.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">entity_serializer</span><span class="p">:</span> <span class="n">serde</span><span class="o">.</span><span class="n">EntitySerializer</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">serde</span><span class="o">.</span><span class="n">EntitySerializer</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Utility for (de)serializing entity metadata (i.e.: exp, runs, models, versions).&quot;</span>
            <span class="s2">&quot;Users may replace this with a different implementation when subclassing the API.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Apply default to cache dir, expand and resolve</span>
        <span class="k">if</span> <span class="n">paths</span><span class="o">.</span><span class="n">is_cwd</span><span class="p">(</span><span class="n">cache</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_default_cache_dir</span><span class="p">()</span>
        <span class="n">pydantic</span><span class="o">.</span><span class="n">force_set_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;cache_dir&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">cache</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

        <span class="c1"># Apply default to temp artifacts dir, expand and resolve</span>
        <span class="k">if</span> <span class="n">paths</span><span class="o">.</span><span class="n">is_cwd</span><span class="p">(</span><span class="n">tmp</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_artifacts_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_artifacts_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">)</span>
        <span class="n">pydantic</span><span class="o">.</span><span class="n">force_set_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;temp_artifacts_dir&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">in_offline_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BaseMlflowApi&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an offline copy of this API.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;offline_mode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Metadata cache locators ===========================================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_metadata_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_exp_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;exp&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_run_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_mv_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;mv&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_exp_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_run_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">encode_model_name</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_mv_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mv_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">encode_model_name</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">version</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Artifact cache locators ===========================================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_artifacts_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;artifacts&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_run_artifacts_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_artifacts_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;runs&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_run_artifact_cache_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">allow_base_resolve</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="n">allow_base_resolve</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_artifacts_cache</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">path_in_run</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_temp_artifacts_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">paths</span><span class="o">.</span><span class="n">ensure_is_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_artifacts_dir</span><span class="p">)))</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Cache protection ==================================================================================</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_lock_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_base_resolve</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="n">allow_base_resolve</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">paths</span><span class="o">.</span><span class="n">dir_lock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact_cache_path</span><span class="p">(</span><span class="n">run_id</span><span class="p">))</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Cache cleanup =====================================================================================</span>

    <span class="k">def</span> <span class="nf">_clean_temp_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">ensure_non_existing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_artifacts_dir</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_all_meta_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mv_cache</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">paths</span><span class="o">.</span><span class="n">dir_lock</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">ensure_empty_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_run_artifact</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">ensure_non_existing</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_all_runs_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">paths</span><span class="o">.</span><span class="n">dir_lock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_artifacts_cache</span><span class="p">)</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">ensure_non_existing</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_all_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_all_meta_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_all_runs_artifacts</span><span class="p">()</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Metadata Getters ==================================================================================</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_meta_fetcher</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fetcher</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">],</span> <span class="n">T</span><span class="p">],</span> <span class="n">args</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">fetcher</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_meta_cache_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_serializer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">def</span> <span class="nf">_write_meta_cache</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">paths</span><span class="o">.</span><span class="n">dir_lock</span><span class="p">(</span><span class="n">lock_dir</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entity_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_write_meta_cache</span>

    <span class="k">def</span> <span class="nf">_get_meta</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fetcher</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">T</span><span class="p">],</span>
        <span class="n">cache_reader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">T</span><span class="p">],</span>
        <span class="n">cache_writer</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">force_cache_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metadata.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force_cache_refresh</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot refresh cache on offline mode.&quot;</span><span class="p">)</span>
            <span class="n">cache_writer</span><span class="p">(</span><span class="n">meta</span> <span class="o">:=</span> <span class="n">fetcher</span><span class="p">())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_mode</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">fetcher</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">cache_reader</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">meta</span>

    <span class="k">def</span> <span class="nf">_get_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Experiment metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fetcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_exp</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_reader</span><span class="p">(</span><span class="n">cache</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp_cache</span><span class="p">(</span><span class="n">exp_id</span><span class="p">),</span> <span class="n">E</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_cache</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">E</span><span class="p">),</span>
            <span class="o">**</span><span class="n">cache_opts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Run metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fetcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_run</span><span class="p">,</span> <span class="n">run_id</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_reader</span><span class="p">(</span><span class="n">cache</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_cache</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span> <span class="n">R</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">run</span><span class="p">:</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_cache</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">R</span><span class="p">)(</span><span class="n">run</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp_cache</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">E</span><span class="p">)(</span><span class="n">run</span><span class="o">.</span><span class="n">exp</span><span class="p">),</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="o">**</span><span class="n">cache_opts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Model metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fetcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_model</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_reader</span><span class="p">(</span><span class="n">cache</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_cache</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">M</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_cache</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span>
            <span class="o">**</span><span class="n">cache_opts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_and_version</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">V</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get ModelVersion metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_fetcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_mv</span><span class="p">,</span> <span class="n">name_and_version</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_reader</span><span class="p">(</span><span class="n">cache</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mv_cache</span><span class="p">(</span><span class="o">*</span><span class="n">name_and_version</span><span class="p">),</span> <span class="n">V</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">mv</span><span class="p">:</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mv_cache</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">V</span><span class="p">)(</span><span class="n">mv</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_cache_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_cache</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">M</span><span class="p">)(</span><span class="n">mv</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="o">**</span><span class="n">cache_opts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_fetch_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_fetch_exp</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_fetch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_fetch_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_fetch_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_fetch_model</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_fetch_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_and_version</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">V</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_fetch_mv</span><span class="p">(</span><span class="n">name_and_version</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_export_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">ensure_only_parents</span><span class="p">(</span><span class="n">target</span> <span class="o">:=</span> <span class="n">target</span> <span class="o">/</span> <span class="n">cache</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Metadata Finders ==================================================================================</span>

    <span class="k">def</span> <span class="nf">_find_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">E</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_cache</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_find_experiments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">R</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_cache</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_find_runs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">M</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_cache</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_find_models</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">V</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mv_cache</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_find_mv</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_meta</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">type_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span>
        <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">,</span>
        <span class="n">finder</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">,</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">Paginator</span><span class="p">[</span><span class="n">T</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_mode</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Metadata search in offline mode may yield incomplete or stale results.&quot;</span><span class="p">)</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_serializer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">paths</span><span class="o">.</span><span class="n">iter_files</span><span class="p">(</span><span class="n">cache</span><span class="p">))</span>
            <span class="n">paginator</span> <span class="o">=</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">Paginator</span><span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">single_page</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">,</span> <span class="n">paginator</span> <span class="o">=</span> <span class="n">finder</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sorting</span><span class="p">:</span>
            <span class="n">paginator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">paginator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">map_pages</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">mongo</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
                        <span class="n">results</span><span class="p">,</span>
                        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                        <span class="n">sorting</span><span class="o">=</span><span class="n">sorting</span><span class="p">,</span>
                        <span class="n">to_doc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                        <span class="n">from_doc</span><span class="o">=</span><span class="n">type_</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">paginator</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">result</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Artifact getters ==================================================================================</span>

    <span class="k">def</span> <span class="nf">_list_run_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transfer</span><span class="o">.</span><span class="n">LsResult</span><span class="p">:</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_mode</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Listing run artifacts in offline mode may yield incomplete or stale results.&quot;</span><span class="p">)</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact_cache_path</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">urls</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">subject</span> <span class="o">:=</span> <span class="n">urls</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)):</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">path</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_transfer</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_pull_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull artifact from run repo to local cache, unless repo is already local.&quot;&quot;&quot;</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_run_artifact</span><span class="p">((</span><span class="n">run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run</span><span class="p">(</span><span class="n">run</span><span class="p">))</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">urls</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">url</span> <span class="o">:=</span> <span class="n">run</span><span class="o">.</span><span class="n">repo_url</span><span class="p">):</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">path_in_run</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_local_artifacts</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Run artifacts repo is local, nothing to pull.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">source</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_transfer</span><span class="o">.</span><span class="n">pull_files</span><span class="p">(</span><span class="n">urls</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">_get_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get path to local run artifact, may trigger a cache pull.&quot;&quot;&quot;</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact_cache_path</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_mode</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">always_pull_artifacts</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pull_run_artifact</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">def</span> <span class="nf">_place_run_artifact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span>
        <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">link</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place local run artifact on target path, may trigger a cache pull.&quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">PathOperation</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span> <span class="k">if</span> <span class="n">link</span> <span class="k">else</span> <span class="s2">&quot;copy&quot;</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">),</span> <span class="n">target</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Arguments pre-processing ==========================================================================</span>

    <span class="k">def</span> <span class="nf">_coerce_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">exp</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">E</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">exp</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected Experiment, ExpApi or experiment ID as string.&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@string_utils</span><span class="o">.</span><span class="n">retval_matches</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">EXP_ID</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_coerce_exp_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">exp</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">E</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">id</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">exp</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected Experiment, ExpApi or experiment ID as string.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coerce_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">run</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">R</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">run</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected Run, RunApi or run ID as string.&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@string_utils</span><span class="o">.</span><span class="n">retval_matches</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">RUN_ID</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_coerce_run_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">run</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">R</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">run</span><span class="o">.</span><span class="n">id</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">run</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected Run, RunApi or run ID as string.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coerce_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">model</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">M</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">model</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected Model, ModelApi or model name as string.&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@string_utils</span><span class="o">.</span><span class="n">retval_matches</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">MODEL_NAME</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_coerce_model_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">model</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">M</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="k">case</span> <span class="nb">str</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">model</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected Model, ModelApi or model name as string.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coerce_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mv</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">V</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">mv</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">V</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">mv</span>
            <span class="k">case</span> <span class="p">(</span><span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">()):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mv</span><span class="p">(</span><span class="o">*</span><span class="n">mv</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected ModelVersion or tuple or (name, version) strings.&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@string_utils</span><span class="o">.</span><span class="n">retval_matches</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">MODEL_NAME</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nd">@string_utils</span><span class="o">.</span><span class="n">retval_matches</span><span class="p">(</span><span class="n">patterns</span><span class="o">.</span><span class="n">MODEL_VERSION</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_coerce_mv_tuple</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mv</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">match</span> <span class="n">mv</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">V</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">mv</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">version</span>
            <span class="k">case</span> <span class="p">(</span><span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">()):</span>
                <span class="k">return</span> <span class="n">mv</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected ModelVersion or tuple or (name, version) strings.&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_valid_path_in_run</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the `path_in_run` for an artifact or model.</span>

<span class="sd">        - Cannot be empty, unless specified</span>
<span class="sd">        - Slashes are trimmed</span>
<span class="sd">        - Cannot do path climbing (e.g.: &quot;../&quot;)</span>
<span class="sd">        - Cannot do current path referencing (e.g.: &quot;./&quot;)</span>

<span class="sd">        Valid path example: &quot;a/b/c&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">path_in_run</span> <span class="o">:=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span> <span class="o">:=</span> <span class="s2">&quot;/root/&quot;</span> <span class="o">+</span> <span class="n">path_in_run</span><span class="p">)</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path_in_run</span>
        <span class="k">if</span> <span class="n">allow_empty</span> <span class="ow">and</span> <span class="n">path_in_run</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path_in_run</span>
        <span class="k">raise</span> <span class="n">paths</span><span class="o">.</span><span class="n">IllegalPath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`path_in_run=</span><span class="si">{</span><span class="n">path_in_run</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Experiment tracking ===============================================================================</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_create_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create experiment and return its metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_create_exp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create registered model and return its metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_create_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model_name</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">tags</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_create_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo</span><span class="p">:</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">,</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">RunIdentifier</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create run with start at current UTC time.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">repo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">parse_url</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">resolve_if_local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_create_run</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_exp_id</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">parent_run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="n">parent</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_run_tags</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_run_status</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_set_run_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_set_run_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">status</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_set_run_end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_set_run_end_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">end_time</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_update_exp_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_update_exp_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_exp_id</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">tags</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_update_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_update_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">tags</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_update_model_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_update_model_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model_name</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">tags</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_update_mv_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mv</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_update_mv_tags</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv_tuple</span><span class="p">(</span><span class="n">mv</span><span class="p">),</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_log_run_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_log_run_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_log_run_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl_log_run_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">metrics</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Model registry ====================================================================================</span>

    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="k">def</span> <span class="nf">_register_mv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">V</span><span class="p">:</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_register_mv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">path_in_run</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Abstract Methods ==================================================================================</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_default_cache_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get default cache dir based on the current MLflow API settings.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_get_exp_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Experiment URL.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_get_run_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Run URL.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_get_model_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get URL to registered model.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_get_mv_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get model version URL.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_fetch_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Experiment by ID.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_fetch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Run by ID.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_fetch_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get registered Model by name.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_fetch_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_and_version</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">V</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get ModelVersion by name and version.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_find_experiments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">,</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">Paginator</span><span class="p">[</span><span class="n">E</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Push down MongoDB query where possible and return query remainder with results iterator.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_find_runs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">,</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">Paginator</span><span class="p">[</span><span class="n">R</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Push down MongoDB query where possible and return query remainder with results iterator.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_find_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">,</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">Paginator</span><span class="p">[</span><span class="n">M</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Push down MongoDB query where possible and return query remainder with results iterator.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_find_mv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">mongo</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span><span class="p">,</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">Paginator</span><span class="p">[</span><span class="n">V</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Push down MongoDB query where possible and return query remainder with results iterator.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_find_child_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">R</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find child runs.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_create_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create experiment and return its metadata.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create registered model and return its metadata.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_create_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">parent_run_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create experiment run.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_set_run_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set Run status.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_set_run_end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set Run end time.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_update_exp_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update Exp tags.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_update_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update Run tags.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_update_model_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update Model tags.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_update_mv_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update Exp tags.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_log_run_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log run params.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_log_run_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log run metrics.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_impl_register_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">V</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register model version.&quot;&quot;&quot;</span>

    <span class="c1"># =======================================================================================================</span>
    <span class="c1"># === Public Methods ====================================================================================</span>

<div class="viewcode-block" id="BaseMlflowApi.clean_all_cache"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.clean_all_cache">[docs]</a>    <span class="k">def</span> <span class="nf">clean_all_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean all cached metadata and artifacts.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_all_cache</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseMlflowApi.clean_temp_artifacts"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.clean_temp_artifacts">[docs]</a>    <span class="k">def</span> <span class="nf">clean_temp_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean temporary artifacts.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_temp_artifacts</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseMlflowApi.clean_cached_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.clean_cached_run_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">clean_cached_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean cached artifact for specified run.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.clean_cached_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.clean_cached_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">clean_cached_model_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean cached artifact for specified model version.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_cached_run_artifact</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.list_run_artifacts"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.list_run_artifacts">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">list_run_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transfer</span><span class="o">.</span><span class="n">LsResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List run artifacts in repo.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_run_artifacts</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.list_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.list_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">list_model_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span> <span class="n">path_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transfer</span><span class="o">.</span><span class="n">LsResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List model version artifacts in repo.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        :param path_suffix: Plain relative path inside model artifact dir (e.g.: `a/b/c`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_run_artifacts</span><span class="p">(</span>
            <span class="n">run</span><span class="o">=</span><span class="p">(</span><span class="n">mv</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">))</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
            <span class="n">path_in_run</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path_suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.cache_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.cache_run_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">cache_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull run artifact from MLflow server to local cache.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pull_run_artifact</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.cache_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.cache_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">cache_model_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull model version artifact from MLflow server to local cache.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_run_artifact</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_run_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get local path to run artifact.</span>

<span class="sd">        Triggers a cache pull on a cache miss or if :attr:`always_pull_artifacts`.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_model_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get local path to model artifact.</span>

<span class="sd">        Triggers a cache pull on a cache miss or if :attr:`always_pull_artifacts`.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_artifact</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.place_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.place_run_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">place_run_artifact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">link</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place run artifact on target path.</span>

<span class="sd">        Triggers a cache pull on a cache miss or if :attr:`always_pull_artifacts`.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param target: Target path.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        :param overwrite: Overwrite target path if exists.</span>
<span class="sd">        :param link: Use symbolic link instead of copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_place_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">path_in_run</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.place_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.place_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">place_model_artifact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">link</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place model version artifact on target path.</span>

<span class="sd">        Triggers a cache pull on a cache miss or if :attr:`always_pull_artifacts`.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        :param target: Target path.</span>
<span class="sd">        :param overwrite: Overwrite target path if exists.</span>
<span class="sd">        :param link: Use symbolic link instead of copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_run_artifact</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.export_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.export_run_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">export_run_artifact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export run artifact cache to target path while keeping the original cache structure.</span>

<span class="sd">        The target path can then be used as cache dir by the `generic` MLflow API in offline mode.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param target: Cache export path.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">paths</span><span class="o">.</span><span class="n">is_sub_dir</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">paths</span><span class="o">.</span><span class="n">is_sub_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">paths</span><span class="o">.</span><span class="n">IllegalPath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot export cache to itself, its subdirs or parents: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cache_dir&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">})</span><span class="o">.</span><span class="n">_get_run_artifact_cache_path</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">rchmod</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">rwx</span><span class="p">)</span>  <span class="c1"># Exported caches are not write-protected</span>
        <span class="k">return</span> <span class="n">target</span></div>

<div class="viewcode-block" id="BaseMlflowApi.export_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.export_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">export_model_artifact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export model version artifact cache to target path while keeping the original cache structure.</span>

<span class="sd">        The target path can then be used as cache dir by the `generic` MLflow API in offline mode.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        :param target: Cache export path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_run_artifact</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.load_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.load_run_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">load_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Path</span><span class="p">],</span> <span class="n">A</span><span class="p">],</span> <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load run artifact.</span>

<span class="sd">        Triggers a cache pull on a cache miss or if :attr:`always_pull_artifacts`.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param loader: Loader callback.</span>
<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_artifact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">path_in_run</span><span class="p">))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.load_model_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.load_model_artifact">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">load_model_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span> <span class="n">loader</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Path</span><span class="p">],</span> <span class="n">A</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load model version artifact.</span>

<span class="sd">        Triggers a cache pull on a cache miss or if :attr:`always_pull_artifacts`.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        :param loader: Loader callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv</span><span class="p">(</span><span class="n">model_version</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading model: </span><span class="si">%s</span><span class="s2"> v</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_run_artifact</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="n">path_in_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.log_run_artifact"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.log_run_artifact">[docs]</a>    <span class="nd">@decorators</span><span class="o">.</span><span class="n">online</span>
    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">log_run_artifact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Path</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_the_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_duplication</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Publish artifact file or dir to experiment run.</span>

<span class="sd">        The flags :paramref:`keep_the_source`, :paramref:`allow_duplication` and :paramref:`use_cache` are</span>
<span class="sd">        experimental and may conflict with one another. It is recommended to leave them unspecified, so this</span>
<span class="sd">        method will do a best-effort to use cache if it makes sense to, keep the source files if it makes</span>
<span class="sd">        sense to (possibly as a symbolic link) and avoid duplicated disk usage when possible.</span>

<span class="sd">        :param run: | Run ID or object.</span>

<span class="sd">        :param source: | Path to artifact file or dir, or a dumper callback.</span>
<span class="sd">                       | If it&#39;s a callback and the upload is interrupted, the temporary artifact is kept.</span>

<span class="sd">        :param path_in_run: Plain relative path inside run artifacts (e.g.: `a/b/c`)</span>

<span class="sd">            - If `source` is a `Path`: Defaults to file or dir name.</span>
<span class="sd">            - If `source` is a callback: No default available.</span>

<span class="sd">        :param keep_the_source:</span>
<span class="sd">            - If `source` is a `Path`: Keep that file or dir (defaults to `True`).</span>
<span class="sd">            - If `source` is a callback: Keep the temporary artifact, even after a successful upload (defaults to `False`).</span>

<span class="sd">        :param allow_duplication: | If `False`, a `source` file or dir may be replaced with a symbolic link to the local cache in order to avoid duplicated disk usage.</span>
<span class="sd">                                  | Defaults to `True` if :paramref:`keep_the_source` is `True` and the run artifacts repo is local.</span>

<span class="sd">        :param use_cache: | If `True`, keep artifact in local cache after publishing.</span>
<span class="sd">                          | Defaults to `True` if the run artifacts repo is remote.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">using_dumper</span> <span class="o">:=</span> <span class="nb">callable</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using temporary artifact path: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_artifacts_dir</span><span class="p">())</span>
            <span class="n">source</span><span class="p">(</span><span class="n">source</span> <span class="o">:=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;artifact&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">:=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span><span class="o">.</span><span class="n">is_relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_artifacts_cache</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">paths</span><span class="o">.</span><span class="n">IllegalPath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source path points to artifact cache: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keep_the_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_the_source</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">using_dumper</span> <span class="k">else</span> <span class="kc">True</span>  <span class="c1"># noqa: SIM211</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">using_dumper</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">path_in_run</span><span class="p">,</span> <span class="s2">&quot;When using an artifact dumper, `path_in_run` must be specified.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path_in_run</span> <span class="o">=</span> <span class="n">path_in_run</span> <span class="ow">or</span> <span class="n">source</span><span class="o">.</span><span class="n">name</span>
            <span class="n">path_in_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_path_in_run</span><span class="p">(</span><span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">repo_is_local</span> <span class="o">:=</span> <span class="n">urls</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">allow_duplication</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">allow_duplication</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">keep_the_source</span> <span class="ow">or</span> <span class="n">use_cache</span> <span class="k">else</span> <span class="kc">False</span>  <span class="c1"># noqa: SIM211,SIM210</span>

                <span class="k">if</span> <span class="n">keep_the_source</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allow_duplication</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot keep the source without duplication when artifacts repo is local&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;move&quot;</span>

                <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">PathOperation</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">move_abs_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">allow_duplication</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">allow_duplication</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">file_transfer</span><span class="o">.</span><span class="n">push_files</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">FailedToPublishArtifact</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Artifact successfully published to &#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_run_artifact</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">,</span> <span class="n">allow_base_resolve</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">repo_is_local</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allow_duplication</span><span class="p">:</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot cache artifact without duplication when run artifacts repo is local&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">keep_the_source</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allow_duplication</span><span class="p">:</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Keeping the `source` as a symbolic link to the cached artifact&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">cache</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">place_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_the_source</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">ensure_non_existing</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">ensure_non_existing</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.log_model_version"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.log_model_version">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">log_model_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">,</span>
        <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Path</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">path_in_run</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_the_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_duplication</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelVersionApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Publish artifact file or dir as model version inside the specified experiment run.</span>

<span class="sd">        :param model: | Model name or object.</span>

<span class="sd">        :param run: | Run ID or object.</span>

<span class="sd">        :param source: | See :paramref:`log_run_artifact.source`</span>

<span class="sd">        :param path_in_run: | Plain relative path inside run artifacts (e.g.: `a/b/c`).</span>
<span class="sd">                            | Defaults to model name.</span>

<span class="sd">        :param keep_the_source: | See :paramref:`log_run_artifact.keep_the_source`</span>

<span class="sd">        :param allow_duplication: | See :paramref:`log_run_artifact.allow_duplication`</span>

<span class="sd">        :param use_cache: | See :paramref:`log_run_artifact.use_cache`</span>

<span class="sd">        :param version: | Arbitrary model version</span>
<span class="sd">                        | (not supported by all backends).</span>

<span class="sd">        :param tags: | Model version tags.</span>
<span class="sd">                     | See :class:`schema.ModelVersion.tags`</span>

<span class="sd">        :return: New model version metadata with API handle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging version of model &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model_name</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="n">path_in_run</span> <span class="o">=</span> <span class="n">path_in_run</span> <span class="ow">or</span> <span class="n">patterns</span><span class="o">.</span><span class="n">encode_model_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_run_artifact</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">,</span> <span class="n">keep_the_source</span><span class="p">,</span> <span class="n">allow_duplication</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ModelVersionApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_register_mv</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">path_in_run</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{}))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_exp_url"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_exp_url">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_exp_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Experiment URL.</span>

<span class="sd">        :param exp: Exp ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_impl_get_exp_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_exp_id</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_run_url"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_run_url">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_run_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Run URL.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param exp: Exp ID or object.</span>

<span class="sd">        Caveats:</span>
<span class="sd">            - :paramref:`exp` must be specified on :attr:`~BaseMlflowApi.offline_mode`</span>
<span class="sd">              if :paramref:`run` is an ID and the run metadata is not in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span> <span class="k">if</span> <span class="n">exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">exp</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_impl_get_run_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_exp_id</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_model_url"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_model_url">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_model_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get URL to registered model.</span>

<span class="sd">        :param model: Model name or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_impl_get_model_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model_name</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_model_version_url"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_model_version_url">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_model_version_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get model version URL.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_impl_get_mv_url</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv_tuple</span><span class="p">(</span><span class="n">model_version</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_exp"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_exp">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExpApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Experiment API by ID.</span>

<span class="sd">        :param exp: Exp ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExpApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_exp_id</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_run"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_run">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Run API by ID.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RunApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_model"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_model">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Model API by name.</span>

<span class="sd">        :param model: Model name or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ModelApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model_name</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_model_version"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_model_version">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_model_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelVersionApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get ModelVersion API by name and version.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ModelVersionApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv_tuple</span><span class="p">(</span><span class="n">model_version</span><span class="p">),</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.find_exps"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.find_exps">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">find_exps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ExpApi</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search experiments with query in MongoDB query language.</span>

<span class="sd">        :param query: Query in MongoDB query language.</span>
<span class="sd">        :param sorting: Sorting criteria (e.g.: `[(&quot;asc_field&quot;, 1), (&quot;desc_field&quot;, -1)]`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ExpApi</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_experiments</span><span class="p">(</span><span class="n">query</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">sorting</span> <span class="ow">or</span> <span class="p">[]))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.find_runs"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.find_runs">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">find_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RunApi</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search runs with query in MongoDB query language.</span>

<span class="sd">        :param query: Query in MongoDB query language.</span>
<span class="sd">        :param sorting: Sorting criteria (e.g.: `[(&quot;asc_field&quot;, 1), (&quot;desc_field&quot;, -1)]`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">RunApi</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_runs</span><span class="p">(</span><span class="n">query</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">sorting</span> <span class="ow">or</span> <span class="p">[]))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.find_models"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.find_models">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">find_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ModelApi</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search registered models with query in MongoDB query language.</span>

<span class="sd">        :param query: Query in MongoDB query language.</span>
<span class="sd">        :param sorting: Sorting criteria (e.g.: `[(&quot;asc_field&quot;, 1), (&quot;desc_field&quot;, -1)]`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ModelApi</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_models</span><span class="p">(</span><span class="n">query</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">sorting</span> <span class="ow">or</span> <span class="p">[]))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.find_model_versions"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.find_model_versions">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">find_model_versions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Query</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sorting</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">Sorting</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ModelVersionApi</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search model versions with query in MongoDB query language.</span>

<span class="sd">        :param query: Query in MongoDB query language.</span>
<span class="sd">        :param sorting: Sorting criteria (e.g.: `[(&quot;asc_field&quot;, 1), (&quot;desc_field&quot;, -1)]`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ModelVersionApi</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_mv</span><span class="p">(</span><span class="n">query</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">sorting</span> <span class="ow">or</span> <span class="p">[]))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.find_child_runs"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.find_child_runs">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">find_child_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RunApi</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find child runs.</span>

<span class="sd">        :param parent: Run ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">RunApi</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl_find_child_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run</span><span class="p">(</span><span class="n">parent</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BaseMlflowApi.cache_exp_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.cache_exp_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">cache_exp_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExpApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get latest Experiment metadata and save to local cache.</span>

<span class="sd">        :param exp: Experiment ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exp</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">force_cache_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.cache_run_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.cache_run_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">cache_run_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get latest Run metadata and save to local cache.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">force_cache_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.cache_model_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.cache_model_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">cache_model_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get latest Model metadata and save to local cache.</span>

<span class="sd">        :param model: Model name or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">force_cache_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.cache_model_version_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.cache_model_version_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">cache_model_version_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelVersionApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get latest model version metadata and save to local cache.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_version</span><span class="p">(</span><span class="n">model_version</span><span class="p">,</span> <span class="n">force_cache_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.export_exp_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.export_exp_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">export_exp_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExpApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export experiment metadata cache to target.</span>

<span class="sd">        :param exp: Experiment ID or object.</span>
<span class="sd">        :param target: Cache export path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_meta</span><span class="p">(</span><span class="n">exp</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exp</span><span class="p">(</span><span class="n">id_</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_exp_id</span><span class="p">(</span><span class="n">exp</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp_cache</span><span class="p">(</span><span class="n">id_</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exp</span></div>

<div class="viewcode-block" id="BaseMlflowApi.export_run_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.export_run_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">export_run_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export run metadata cache to target.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param target: Cache export path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_meta</span><span class="p">(</span><span class="n">run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">id_</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_cache</span><span class="p">(</span><span class="n">id_</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_exp_meta</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">run</span></div>

<div class="viewcode-block" id="BaseMlflowApi.export_model_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.export_model_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">export_model_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export model metadata cache to target.</span>

<span class="sd">        :param model: Model name or object.</span>
<span class="sd">        :param target: Cache export path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_model_name</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_meta</span><span class="p">(</span><span class="n">model</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_cache</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="BaseMlflowApi.export_model_version_meta"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.export_model_version_meta">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">export_model_version_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mv</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelVersionApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export model version metadata cache to target.</span>

<span class="sd">        :param mv: Model version object or `(name, version)` tuple.</span>
<span class="sd">        :param target: Cache export path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_mv_tuple</span><span class="p">(</span><span class="n">mv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_meta</span><span class="p">(</span><span class="n">mv</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_version</span><span class="p">(</span><span class="n">tup</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mv_cache</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_model_meta</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mv</span></div>

<div class="viewcode-block" id="BaseMlflowApi.create_exp"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.create_exp">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">create_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExpApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Experiment and return its API.</span>

<span class="sd">        :param name: See :attr:`schema.Experiment.name`.</span>
<span class="sd">        :param tags: See :attr:`schema.Experiment.tags`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExpApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_exp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{}))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_or_create_exp"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_or_create_exp">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_or_create_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExpApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create Experiment and return its API.</span>

<span class="sd">        :param name: See :attr:`schema.Experiment.name`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_experiments</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span> <span class="p">[]):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_exp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{})</span>

        <span class="k">return</span> <span class="n">ExpApi</span><span class="p">(</span><span class="o">**</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.create_model"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.create_model">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create registered model and return its API.</span>

<span class="sd">        :param name: See :attr:`schema.Model.name`.</span>
<span class="sd">        :param tags: See :attr:`schema.Model.tags`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ModelApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{}))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.get_or_create_model"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.get_or_create_model">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">get_or_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create registered Model and return its API.</span>

<span class="sd">        :param name: See :attr:`schema.Model.name`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_models</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span> <span class="p">[]):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{})</span>

        <span class="k">return</span> <span class="n">ModelApi</span><span class="p">(</span><span class="o">**</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.create_run"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.create_run">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">create_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">RunIdentifier</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Declare a new experiment run to be used later.</span>

<span class="sd">        :param exp: Experiment ID or object.</span>
<span class="sd">        :param name: See :attr:`schema.Run.name`.</span>
<span class="sd">        :param tags: See :attr:`schema.Run.tags`.</span>
<span class="sd">        :param repo: (Experimental) Cloud storage URL to be used as alternative run artifacts repository.</span>
<span class="sd">        :param parent: Parent run ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RunApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_run</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">SCHEDULED</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.start_run"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.start_run">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">start_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">urls</span><span class="o">.</span><span class="n">Url</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">RunIdentifier</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a new experiment run.</span>

<span class="sd">        :param exp: Experiment ID or object.</span>
<span class="sd">        :param name: See :attr:`schema.Run.name`.</span>
<span class="sd">        :param tags: See :attr:`schema.Run.tags`.</span>
<span class="sd">        :param repo: (Experimental) Cloud storage URL to be used as alternative run artifacts repository.</span>
<span class="sd">        :param parent: Parent run ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RunApi</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_run</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.resume_run"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.resume_run">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">resume_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resume a previous experiment run.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_run_status</span><span class="p">(</span><span class="n">run_id</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.end_run"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.end_run">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">end_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">succeeded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunApi</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End experiment run.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param succeeded: Whether the run was successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">FINISHED</span> <span class="k">if</span> <span class="n">succeeded</span> <span class="k">else</span> <span class="n">schema</span><span class="o">.</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">FAILED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_run_status</span><span class="p">(</span><span class="n">run_id</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_run_id</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_run_end_time</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.set_tags_on_exp"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.set_tags_on_exp">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">set_tags_on_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ExpIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set tags on experiment.</span>

<span class="sd">        :param exp: Experiment ID or object.</span>
<span class="sd">        :param tags: See :attr:`schema.Experiment.tags`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_exp_tags</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.set_tags_on_run"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.set_tags_on_run">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">set_tags_on_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set tags on experiment run.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param tags: See :attr:`schema.Run.tags`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_run_tags</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.set_tags_on_model"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.set_tags_on_model">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">set_tags_on_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set tags on registered model.</span>

<span class="sd">        :param model: Model name or object.</span>
<span class="sd">        :param tags: See :attr:`schema.Model.tags`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_model_tags</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.set_tags_on_model_version"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.set_tags_on_model_version">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">set_tags_on_model_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_version</span><span class="p">:</span> <span class="n">ModelVersionIdentifier</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set tags on model version.</span>

<span class="sd">        :param model_version: Model version object or `(name, version)` tuple.</span>
<span class="sd">        :param tags: See :attr:`schema.Model.tags`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mv_tags</span><span class="p">(</span><span class="n">model_version</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.log_params"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.log_params">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">log_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log params to experiment run.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param params: See :attr:`schema.Run.params`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_run_params</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseMlflowApi.log_metrics"><a class="viewcode-back" href="../../../../rst/mlflow/apis/base.html#mlopus.mlflow.BaseMlflowApi.log_metrics">[docs]</a>    <span class="nd">@pydantic</span><span class="o">.</span><span class="n">validate_arguments</span>
    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">RunIdentifier</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log metrics to experiment run.</span>

<span class="sd">        :param run: Run ID or object.</span>
<span class="sd">        :param metrics: See :attr:`schema.Run.metrics`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_run_metrics</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>